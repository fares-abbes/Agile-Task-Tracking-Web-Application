<app-navbar></app-navbar>

<div class="min-h-screen bg-slate-900">
  <div class="flex">
    <div class="hidden md:block w-64">
      <app-sidebar></app-sidebar>
    </div>

    <main class="flex-1 p-4">
      <div class="max-w-4xl mx-auto">
        <div class="flex items-center justify-between mb-6">
          <div>
            <h1 class="text-2xl font-bold text-white">Projects</h1>
            <p class="text-sm text-slate-400">Team projects — modern list view</p>
          </div>

          <div class="flex items-center gap-3">
            <button (click)="toggleAdd()" class="px-3 py-2 bg-emerald-500 hover:bg-emerald-400 text-white rounded-md">
              {{ showAddForm ? 'Close' : 'New Project' }}
            </button>
          </div>
        </div>

        <form *ngIf="showAddForm" [formGroup]="addForm" (ngSubmit)="addProject()"
              class="mb-6 p-4 bg-slate-800/60 rounded-lg grid grid-cols-1 sm:grid-cols-3 gap-3">
          <input formControlName="projectName" placeholder="Project name" class="px-3 py-2 rounded bg-slate-700 text-white col-span-2" />

          <!-- client dropdown populated from GET /api/clients/GetAllClients -->
          <select formControlName="clientId" class="px-3 py-2 rounded bg-slate-700 text-white">
            <option [ngValue]="0">No client</option>
            <option *ngFor="let c of clients" [ngValue]="c.clientId">{{ c.clientName }}</option>
          </select>

          <textarea formControlName="description" placeholder="Description" class="col-span-full px-3 py-2 rounded bg-slate-700 text-white"></textarea>

          <!-- new fields: status, startDate, endDate -->
          <select formControlName="status" class="px-3 py-2 rounded bg-slate-700 text-white col-span-1">
            <option value="PLANNED">Planned</option>
            <option value="ACTIVE">Active</option>
            <option value="COMPLETED">Completed</option>
            <option value="ON_HOLD">On Hold</option>
            <option value="CANCELLED">Cancelled</option>
          </select>

          <input type="date" formControlName="startDate" class="px-3 py-2 rounded bg-slate-700 text-white" />
          <input type="date" formControlName="endDate" class="px-3 py-2 rounded bg-slate-700 text-white" />

          <div class="col-span-full flex gap-2 mt-2 justify-end">
            <button type="submit" class="px-3 py-2 bg-emerald-500 text-white rounded-md">Add</button>
            <button type="button" (click)="toggleAdd()" class="px-3 py-2 bg-slate-700 text-slate-200 rounded-md">Cancel</button>
          </div>
        </form>

        <div *ngIf="error" class="text-rose-400 mb-4">Failed to load projects.</div>
        <div *ngIf="loading" class="text-slate-400 mb-4">Loading...</div>
        <div *ngIf="!loading && projects.length === 0" class="text-slate-400 text-center py-8 rounded-lg bg-slate-800/40">
          No projects found
        </div>

        <!-- project list: show status and dates -->
        <ul *ngIf="projects.length > 0" class="space-y-3">
          <li *ngFor="let p of projects" class="bg-slate-800/50 rounded-lg p-4 flex items-start justify-between gap-4 shadow">
            <div class="flex items-start gap-3 min-w-0">
              <div class="flex-none w-12 h-12 rounded-md bg-emerald-700/10 text-emerald-300 flex items-center justify-center font-semibold">
                {{ (p.projectName || '–').charAt(0) }}
              </div>
              <div class="min-w-0">
                <div class="flex items-center gap-2">
                  <div class="text-sm text-slate-400">Project</div>
                  <div class="text-xs px-2 py-0.5 rounded-full"
                       [ngClass]="{
                         'bg-green-700 text-white': p.status === 'COMPLETED',
                         'bg-emerald-600 text-white': p.status === 'ACTIVE',
                         'bg-yellow-700 text-white': p.status === 'PLANNED' || p.status === 'ON_HOLD',
                         'bg-rose-600 text-white': p.status === 'CANCELLED',
                         'bg-slate-700 text-slate-200': !p.status
                       }">
                    {{ p.status || 'PLANNED' }}
                  </div>
                </div>

                <div class="text-lg font-semibold text-white truncate">{{ p.projectName }}</div>
                <div class="text-xs text-slate-400 truncate">{{ p.description || '—' }}</div>
                <div class="text-xs text-slate-500 mt-1">Client: {{ p.clientNameDisplay || '—' }}</div>
                <div class="text-xs text-slate-400 mt-1">Start: {{ p.startDate || '—' }} • End: {{ p.endDate || '—' }}</div>
              </div>
            </div>

            <div class="flex flex-col items-end gap-2">
              <div class="text-xs text-slate-400">{{ p.createdAt ? (p.createdAt | date:'short') : '—' }}</div>

              <div class="flex gap-2">
                <button *ngIf="editProjectId !== p.projectId" (click)="startEdit(p)" class="px-2 py-1 text-xs rounded bg-slate-700 text-slate-200">Edit</button>
                <button *ngIf="editProjectId === p.projectId" (click)="updateProject()" class="px-2 py-1 text-xs rounded bg-emerald-500 text-white">Save</button>
                <button (click)="deleteProject(p.projectId)" class="px-2 py-1 text-xs rounded bg-rose-600 text-white">Delete</button>
              </div>
            </div>

            <div *ngIf="editProjectId === p.projectId" class="col-span-full mt-3 w-full">
              <div class="mt-3 grid grid-cols-1 sm:grid-cols-3 gap-2">
                <input [formControl]="editForm.controls.projectName" placeholder="Name" class="px-2 py-1 rounded bg-slate-700 text-white col-span-2" />
                <select [formControl]="editForm.controls.clientId" class="px-2 py-1 rounded bg-slate-700 text-white">
                  <option [ngValue]="0">No client</option>
                  <option *ngFor="let c of clients" [ngValue]="c.clientId">{{ c.clientName }}</option>
                </select>

                <select [formControl]="editForm.controls.status" class="px-2 py-1 rounded bg-slate-700 text-white col-span-1">
                  <option value="PLANNED">Planned</option>
                  <option value="ACTIVE">Active</option>
                  <option value="COMPLETED">Completed</option>
                  <option value="ON_HOLD">On Hold</option>
                  <option value="CANCELLED">Cancelled</option>
                </select>

                <input type="date" [formControl]="editForm.controls.startDate" class="px-2 py-1 rounded bg-slate-700 text-white" />
                <input type="date" [formControl]="editForm.controls.endDate" class="px-2 py-1 rounded bg-slate-700 text-white" />
                <textarea [formControl]="editForm.controls.description" placeholder="Description" class="col-span-full px-2 py-1 rounded bg-slate-700 text-white"></textarea>

                <div class="col-span-full flex gap-2 mt-2 justify-end">
                  <button (click)="updateProject()" class="px-3 py-1 bg-emerald-500 text-white rounded">Save</button>
                  <button (click)="cancelEdit()" class="px-3 py-1 bg-slate-700 text-slate-200 rounded">Cancel</button>
                </div>
              </div>
            </div>
          </li>
        </ul>

      </div>
    </main>
  </div>
</div>

<!-- undo toasts -->
<div class="fixed right-4 bottom-4 space-y-2 z-50">
  <div *ngFor="let p of pendingDeletes" class="flex items-center gap-3 px-4 py-2 rounded-lg bg-slate-800/80 shadow-lg">
    <div class="text-sm text-slate-200">Deleted <span class="font-medium">{{ p.project.projectName }}</span></div>
    <div class="text-xs text-slate-400">({{ secondsLeft(p) }}s)</div>
    <button (click)="undoDelete(p.project.projectId)" class="ml-3 px-3 py-1 bg-emerald-500 text-white rounded">Undo</button>
  </div>
</div>
